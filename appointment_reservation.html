<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Saville Assessment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
<div class="container">
    <br>
    <h2>Saville Assessment</h2>
    <br>
<!--
https://docs.google.com/forms/d/e/1FAIpQLSfhHjTXiq36oXQsF4mi1KoybpgRpFgtsNDGZ7QTNuH-yPopig/viewform?usp=pp_url&entry.419549455=name&entry.1183040921=id&entry.59009024=mail&entry.585382209=mobile&entry.571319333=date(22-7)+-+trainer(khaled)+-+location(GA)+-+session(1)
-->	
		<div class="row mb-3">
		  <label for="entry.419549455" class="col-sm-2 col-form-label">Name</label>
		  <div class="col-sm-10">
		    <input type="text" class="form-control" id="entry.419549455" name="entry.419549455" placeholder="name">
		  </div>
		</div>
		<div class="row mb-3">
		  <label for="entry.1183040921" class="col-sm-2 col-form-label">ID</label>
		  <div class="col-sm-10">
		    <input type="number" class="form-control" id="entry.1183040921" name="entry.1183040921" placeholder="id">
		  </div>
		</div>
		<div class="row mb-3">
		  <label for="entry.59009024" class="col-sm-2 col-form-label">Email</label>
		  <div class="col-sm-10">
		    <input type="email" class="form-control" id="entry.59009024" name="entry.59009024" placeholder="email">
		  </div>
		</div>
		<div class="row mb-3">
		  <label for="entry.585382209" class="col-sm-2 col-form-label">Mobile</label>
		  <div class="col-sm-10">
		    <input type="number" class="form-control" id="entry.585382209" name="entry.585382209" placeholder="mobile">
		  </div>
		</div>
		<div class="daysList">
    	
		</div>
		<input type="button" class="submit_btn" value="submit" name="">
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
  <script type="text/javascript">
  	

  	const sheet_url = "https://docs.google.com/spreadsheet/ccc?key=1UKlY3zSDkNfVf9e0w3eYSaM8b2ft6RG3Y7rHviaVbBA&output=xlsx"
  	
  	getData()


  	document.querySelector('.submit_btn').addEventListener('click', function(event){
  		event.preventDefault();


  		let nameInput = document.querySelector('[name="entry.419549455"]').value;
  		let idInput = document.querySelector('[name="entry.1183040921"]').value;
  		let emailInput = document.querySelector('[name="entry.59009024"]').value;
  		let mobileInput = document.querySelector('[name="entry.585382209"]').value;

  		let selectedInput = document.querySelector('[name="entry.571319333"]:checked').value;

  		if(selectedInput!='' && selectedInput!='undefined')
  		window.open(`https://docs.google.com/forms/d/e/1FAIpQLSfhHjTXiq36oXQsF4mi1KoybpgRpFgtsNDGZ7QTNuH-yPopig/viewform?usp=pp_url&entry.419549455=${nameInput}&entry.1183040921=${idInput}&entry.59009024=${emailInput}&entry.585382209=${mobileInput}&entry.571319333=${selectedInput}`)

  	})



function getData() {
xhr = new XMLHttpRequest();
xhr.open('GET', 'https://docs.google.com/spreadsheet/ccc?key=1UKlY3zSDkNfVf9e0w3eYSaM8b2ft6RG3Y7rHviaVbBA&output=xlsx', true);
xhr.responseType = 'arraybuffer';

xhr.addEventListener('load', function() {

            arraybuffer = xhr.response;

            // /* convert data to binary string */
            arraybuffer = new Uint8Array(arraybuffer);

            var workbook = XLSX.read(arraybuffer, {
			        type: 'buffer'
			      });

            let counter = 0;
            let optionsJson = [];
            let mainJson = [];

			      workbook.SheetNames.forEach(function(sheetName) {
			        // Here is your object
			        var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
			        var json_object = JSON.stringify(XL_row_object);
			        
			        if(counter==0)
			        {
			        	mainJson = JSON.parse(json_object);
			        }
			        else if(counter==1)
			        {
			        	optionsJson = JSON.parse(json_object);
			        }

			        counter++
			        //console.log(json_object);

			      })

			      // fill form accordingly

			      appendData(optionsJson);

    });

    xhr.send(null);
}


function appendData(jsonArray){


	let dates = jsonArray.map(e=>e.options.split('|')[0].trim());
			dates = dates.filter(onlyUnique);

			dates.forEach(date=>{

			const dateArray=date.split("-");
			const day=dateArray[0].trim();
			const month=dateArray[1].trim();
			const year=dateArray[2].trim();	

			let assessors =[];

			jsonArray.forEach(e=>{


				if(e.day.trim() == day && e.month.trim() == month && e.year.trim() == year)
				{
					assessors.push(e.assessors)
				}
			});
			assessors = assessors.filter(onlyUnique);

			//add array to store free sessions for each user
			assessors = assessors.map(item=>{
				return {"name":item,"sessions":[]}
			});

			//console.log(assessors);

			jsonArray.forEach(e=>{

				if(e.day.trim() == day && e.month.trim() == month && e.year.trim() == year)
				{
					assessors.forEach(o=>{
						if(o.name == e.assessors)
							o.sessions.push({"sname":e.session,"status":e.status});
					})
				}
			});

			appendDayBlock(date,assessors);

			})
}

function appendDayBlock(date,assessors){
	
	console.log(date,assessors);

	let tableHeader = `
		    	<table class="table table-success table-striped">
    		<thead>
    			<th>${date}</th>
    			<th>10:00 AM - 11:00 AM</th>
    			<th>11:30 AM - 12:30 PM</th>
    			<th>1:00 PM - 2:00 PM</th>
    			<th>2:30 PM - 3:30 PM</th>
    			<th>4 PM - 5 PM</th>
    		</thead>
    		<tbody>`;

  const tableEnd = `</tbody>
		</table>`;

		assessors.forEach(e=>{

			tableHeader = `${tableHeader} <tr>
    				<th>${e.name}</th>`

			let tds = 
			e.sessions.map(s=>{

				if(s.status=='Free')
					return `<td>
    						<input type="radio" name="entry.571319333" 
    						value="${date} | Assessor: ${e.name} | session: ${s.sname}"/>
    					</td>`;
    		else
    				return `<td>
    					Reserved
    				</td>`;

			}).join('');

			tableHeader = `${tableHeader} ${tds}`;

		})

		tableHeader = `${tableHeader} ${tableEnd}`; 		

	document.querySelector(".daysList").insertAdjacentHTML('beforeend',tableHeader);


}


function onlyUnique(value, index, array) {
  return array.indexOf(value) === index;
}


  </script>
  </body>
</html>
